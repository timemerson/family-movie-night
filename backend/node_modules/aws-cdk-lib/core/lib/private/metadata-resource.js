"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MetadataResource=void 0,exports.formatAnalytics=formatAnalytics,exports.parseAnalytics=parseAnalytics;var zlib=()=>{var tmp=require("zlib");return zlib=()=>tmp,tmp},constructs_1=()=>{var tmp=require("constructs");return constructs_1=()=>tmp,tmp},cxapi=()=>{var tmp=require("../../../cx-api");return cxapi=()=>tmp,tmp},region_info_1=()=>{var tmp=require("../../../region-info");return region_info_1=()=>tmp,tmp},cfn_condition_1=()=>{var tmp=require("../cfn-condition");return cfn_condition_1=()=>tmp,tmp},cfn_fn_1=()=>{var tmp=require("../cfn-fn");return cfn_fn_1=()=>tmp,tmp},cfn_pseudo_1=()=>{var tmp=require("../cfn-pseudo");return cfn_pseudo_1=()=>tmp,tmp},cfn_resource_1=()=>{var tmp=require("../cfn-resource");return cfn_resource_1=()=>tmp,tmp},errors_1=()=>{var tmp=require("../errors");return errors_1=()=>tmp,tmp},feature_flags_1=()=>{var tmp=require("../feature-flags");return feature_flags_1=()=>tmp,tmp},lazy_1=()=>{var tmp=require("../lazy");return lazy_1=()=>tmp,tmp},token_1=()=>{var tmp=require("../token");return token_1=()=>tmp,tmp},stack_metadata_1=()=>{var tmp=require("./stack-metadata");return stack_metadata_1=()=>tmp,tmp};class MetadataResource extends constructs_1().Construct{constructor(scope,id){if(super(scope,id),token_1().Token.isUnresolved(scope.region)||region_info_1().RegionInfo.get(scope.region).cdkMetadataResourceAvailable){const constructAnalytics=filteredConstructAnalyticsFromStack(scope),resource=new(cfn_resource_1()).CfnResource(this,"Default",{type:"AWS::CDK::Metadata",properties:{Analytics:lazy_1().Lazy.string({produce:()=>formatAnalytics(constructAnalytics)})}});if(token_1().Token.isUnresolved(scope.region)){const condition=new(cfn_condition_1()).CfnCondition(this,"Condition",{expression:makeCdkMetadataAvailableCondition()});condition.overrideLogicalId("CDKMetadataAvailable"),resource.cfnOptions.condition=condition}}}}exports.MetadataResource=MetadataResource;function filteredConstructAnalyticsFromStack(scope){const includeAdditionalTelemetry=feature_flags_1().FeatureFlags.of(scope).isEnabled(cxapi().ENABLE_ADDITIONAL_METADATA_COLLECTION)??!1,constructAnalytics=(0,stack_metadata_1().constructAnalyticsFromScope)(scope);if(includeAdditionalTelemetry)return constructAnalytics;return constructAnalytics.map(retainAlwaysReportedAnalytics);function retainAlwaysReportedAnalytics(analytics){return{fqn:analytics.fqn,version:analytics.version,metadata:analytics.metadata}}}function makeCdkMetadataAvailableCondition(){return cfn_fn_1().Fn.conditionOr(...region_info_1().RegionInfo.regions.filter(ri=>ri.cdkMetadataResourceAvailable).map(ri=>cfn_fn_1().Fn.conditionEquals(cfn_pseudo_1().Aws.REGION,ri.name)))}class Trie extends Map{}function formatAnalytics(infos){const trie=new Trie;infos.forEach(info=>insertFqnInTrie(`${info.version}!${info.fqn}`,trie,[info.metadata,info.additionalTelemetry].flatMap(a=>a??[])));const plaintextEncodedConstructs=prefixEncodeTrie(trie),compressedConstructsBuffer=zlib().gzipSync(Buffer.from(plaintextEncodedConstructs));setGzipOperatingSystemToUnknown(compressedConstructsBuffer);const analyticsString=`v2:deflate64:${compressedConstructsBuffer.toString("base64")}`;if(process.env.CDK_CONTEXT_JSON&&JSON.parse(process.env.CDK_CONTEXT_JSON)["cdk-migrate"]){const compressedAppInfo=zlib().gzipSync(Buffer.from("cdk-migrate")).toString("base64");analyticsString.concat(":",compressedAppInfo)}return analyticsString}function parseAnalytics(analyticsString){const analyticsData=analyticsString.split(":");if(analyticsData.length>=3&&analyticsData[0]==="v2"&&analyticsData[1]==="deflate64"){const buffer=Buffer.from(analyticsData[2],"base64"),prefixEncodedList=zlib().gunzipSync(buffer).toString("utf8"),trie=parsePrefixEncodedList(prefixEncodedList);return trieToConstructInfos(trie)}else throw new(errors_1()).AssumptionError(`Invalid analytics string: ${analyticsString}`)}function trieToConstructInfos(trie){const infos=[];function traverse(node,path){if(node.size===0){const[version,fqn]=path.split("!");infos.push({version,fqn})}for(const[key,value]of node.entries())traverse(value,path+key)}return traverse(trie,""),infos}function insertFqnInTrie(fqn,trie,metadata){for(const fqnPart of fqn.replace(/[^a-z0-9]/gi,"$& ").split(" ")){const nextLevelTreeRef=trie.get(fqnPart)??new Trie;trie.set(fqnPart,nextLevelTreeRef),trie=nextLevelTreeRef}return metadata?.length&&trie.set(JSON.stringify(metadata),new Trie),trie}function prefixEncodeTrie(trie){let prefixEncoded="",isFirstEntryAtLevel=!0;return[...trie.entries()].forEach(([key,value])=>{isFirstEntryAtLevel||(prefixEncoded+=","),isFirstEntryAtLevel=!1,prefixEncoded+=key,value.size>1?(prefixEncoded+="{",prefixEncoded+=prefixEncodeTrie(value),prefixEncoded+="}"):prefixEncoded+=prefixEncodeTrie(value)}),prefixEncoded}function parsePrefixEncodedList(data){const trie=new Trie;let i=0;function parse(currentTrie,prefix){let token="";for(;i<data.length;){const char=data[i];if(char==="{")i++,parse(currentTrie,prefix+token),token="";else if(char==="}"||char===","){if(token&&insertFqnInTrie(prefix+token,trie),i++,char==="}")return;token=""}else token+=char,i++}token&&insertFqnInTrie(prefix+token,trie)}return parse(trie,""),trie}function setGzipOperatingSystemToUnknown(gzipBuffer){if(gzipBuffer[0]!==31||gzipBuffer[1]!==139)throw new(errors_1()).AssumptionError("Expecting a gzip buffer (must start with 0x1f8b)");gzipBuffer[9]=255}
